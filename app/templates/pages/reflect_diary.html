{% extends '_base.html' %} 

{% block title %}
Daily Mindfulness
{% endblock title %} 

{% block css_files %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='styles/combined.css') }}"
/>
{% endblock css_files %} 

{% block contents %}
<div class="container" style="margin-top:30px">
  <div class="d-flex justify-content-center align-items-center">
    <div class="d-flex" style="flex: 1; padding:20px;">
      <div class="d-flex flex-column" style="flex: 1;">
        <p>We recommend you to engage in at least 4-5 exchanges with the following bot. You should click on "Save and Continue" after your interaction.</p>
        <div class="container d-flex p-0" style="flex:1;">          
          <iframe
            id="reflect-iframe"
            src="{{ url_for('reflect_bot', user_id=12345, convo_end=0) }}"
            width="100%"
            height="100%"
          ></iframe>
        </div>
      </div>
      <div class="d-flex" style="flex: 1;">
        <form id="diary" method="post" enctype="multipart/form-data">
          {{ form.hidden_tag() }}
          {% include 'pages/includes/diary.html' %}
          {{ form.diary_1(hidden='true', id='form-diary-1') }}
          {{ form.diary_2(hidden='true', id='form-diary-2') }}
          {{ form.diary_3(hidden='true', id='form-diary-3') }}
          {{ form.diary_4(hidden='true', id='form-diary-4') }}
          {{ form.diary_5(hidden='true', id='form-diary-5') }}
          {{ form.diary_6(hidden='true', id='form-diary-6') }}
          {{ form.diary_7(hidden='true', id='form-diary-7') }}
          {{ form.diary_8(hidden='true', id='form-diary-8') }}
          {{ form.diary_9(hidden='true', id='form-diary-9') }}
          {{ form.submit(hidden='true', id='form-submit') }}
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock contents %}

{% block js_files %}
<script>
var BOT_URL_REGEX = /(http[s]?:\/\/[\w.:]+\/reflect_bot)(\/[^\/]+)(\/[^\/]*)?(?=(\/[01]))/;

var ReflectDiary = function() {
  this.formDiary1 = document.getElementById(`form-diary-1`),
  this.formDiary2 = document.getElementById(`form-diary-2`),
  this.formDiary3 = document.getElementById(`form-diary-3`),
  this.formDiary4 = document.getElementById(`form-diary-4`),
  this.formDiary5 = document.getElementById(`form-diary-5`),
  this.formDiary6 = document.getElementById(`form-diary-6`),
  this.formDiary7 = document.getElementById(`form-diary-7`),
  this.formDiary8 = document.getElementById(`form-diary-8`),
  this.formDiary9 = document.getElementById(`form-diary-9`),
  this.formSubmit = document.getElementById(`form-submit`),
  this.reflectBot = document.getElementById(`reflect-iframe`),
  this.diary1 = document.getElementById(`question1`),
  this.diary2 = document.getElementById(`question2`),
  this.diary3 = document.getElementById(`question3`),
  this.diary4 = document.getElementById(`question4`),
  this.diary5 = document.getElementById(`question5`),
  this.diary6 = document.getElementById(`question6`),
  this.diary7 = document.getElementById(`question7`),
  this.diary8 = document.getElementById(`question8`),
  this.diary9 = document.getElementById(`question9`),
  this.submitBtn = document.getElementById(`submit-btn`),
  this.startTime = new Date("{{convo_start}}").getTime()
}

ReflectDiary.prototype = {
  ini: function() {
    this._prepareAPI();
    this._prepareFrontEnd();
    this._addEventListner();
  },
  _prepareFrontEnd: function() {
    this.diary1.value = this.formDiary1.value;
    this.diary2.value = this.formDiary2.value;
    this.diary3.value = this.formDiary3.value;
    this.diary4.value = this.formDiary4.value;
    this.diary5.value = this.formDiary5.value;
    this.diary6.value = this.formDiary6.value;
    this.diary7.value = this.formDiary7.value;
    this.diary8.value = this.formDiary8.value;
    this.diary9.value = this.formDiary9.value;

    const match = this.reflectBot.src.match(BOT_URL_REGEX);
    let show_bot_avatar = match[3] !== undefined ? match[3] : '';    
    this.reflectBot.src = match[1] + '/{{user_id}}' + show_bot_avatar + match[4];

    console.log(match)
    console.log('/{{user_id}}')
    console.log(match[1] + '/{{user_id}}' + show_bot_avatar + match[4])
  },
  _prepareAPI: function() {
    var that = this;

    this.syncValueChange = function(items) {
      let curr = this;

      items.forEach(item => {
          item.value = curr.value;
      });
    }

    this.onReady = (target, selector, event, callback) => {
      let clickables = [...target.querySelectorAll(selector)];

      let clickObserver = function(nodeID) {
        callback(nodeID);
      };

      clickables.forEach(el => {
          el.addEventListener(event, clickObserver.bind(el, el), true);
      });
    };

    this.inactivateBot = () => {
      const match = that.reflectBot.src.match(BOT_URL_REGEX);
      
      try {
        if (match[4] === '/0') {
          let show_bot_avatar = match[3] !== undefined ? match[3] : '';
          that.reflectBot.src = match[1] + match[2] + show_bot_avatar + '/1';
        }
      } catch {
        console.log('Reflect bot not found!');
      }
    }
  },
  _addEventListner: function() {
    var that = this;

    this.diary1.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary1, [that.formDiary1])
    );

    this.diary2.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary2, [that.formDiary2])
    );

    this.diary3.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary3, [that.formDiary3])
    );

    this.diary4.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary4, [that.formDiary4])
    );

    this.diary5.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary5, [that.formDiary5])
    );

    this.diary6.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary6, [that.formDiary6])
    );

    this.diary7.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary7, [that.formDiary7])
    );

    this.diary8.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary8, [that.formDiary8])
    );

    this.diary9.addEventListener(
      "input", 
      that.syncValueChange.bind(that.diary9, [that.formDiary9])
    );

    this.submitBtn.addEventListener(
      "click",
      function() {

        console.log(`clicked!!!`);

        that.formSubmit.click();
      }
    );

    //if (((new Date().getTime() - this.startTime) % (1000 * 60 * 60)) / (1000 * 60) > 5) {
    //  this.inactivateBot();
    //} else {
    //  // Update the count down every 1 second
    //  let countDownEvent = setInterval(function() {

    //    // Find the distance between now and the count down date
    //    let distance = new Date().getTime() - that.startTime;

    //    // Time calculations for days, hours, minutes and seconds
    //    // let days = Math.floor(distance / (1000 * 60 * 60 * 24));
    //    // let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    //    let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    //    // let seconds = Math.floor((distance % (1000 * 60)) / 1000);

    //    // If the count down is finished in 5 minutes
    //    if (minutes > 5) {
    //      clearInterval(countDownEvent);

    //      that.inactivateBot();
    //    }
    //  }, 1000);
    //}
  }
};

window.onload = function() {
  new ReflectDiary().ini();
};
</script>
{% endblock js_files %}
